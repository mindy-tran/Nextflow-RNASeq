---
title: "Week 3: RNAseq"
output:
  html_document:
    toc: true
    fig_caption: true
---
```{r echo = T, results = 'hide'}

# Install fgsea if not already installed
if (!requireNamespace("fgsea", quietly = TRUE)) {
    install.packages("BiocManager")
    BiocManager::install("fgsea")
}

# Load necessary libraries
library(fgsea)
library(msigdbr)
library(DESeq2)
library(ggplot2)
library(dplyr)
library(tibble)
library(pheatmap)
library(fgsea)
library(tidyverse)
```

## Evaluate the QC metrics for the full data

The sequencing reads show high overall quality, with median Phred scores consistently above Q30 across the read length. While the first 10 base pairs show slightly lower quality scores (ranging from Q26 to Q35), the scores stabilize above Q30 beyond first 10 base pairs and maintain high accuracy even at 100 base pairs. The per-sequence quality distribution confirms that large proportion of reads have high-quality scores, supporting the reliability of our sequencing data. The per-base sequence content suggests some nucleotide composition bias within the first 10 base pairs, but this diminishes by position 12 and the nucleotide distributions remain stable. The GC content distribution follows a normal pattern, suggesting no significant deviations due to contamination or library preparation bias. Adapter content is small, with less than 1% cumulative adapter presence detected, indicating that adapter trimming is likely unnecessary. Overall, our sequencing data is high quality has no major concerns that would impact downstream analysis.

## Filtering the counts matrix
I filtered out genes with less than 10 counts across all samples. Before filtering, the dataset contained 63,241 genes. After filtering, 27,723 genes remained. The distribution of gene counts before (red) and after (cyan) filtering is shown in the histogram below and shows the removal of low-expression genes.

```{r}


# Read the counts matrix
counts <- read.table("results/concat_counts_matrix.tsv", header = TRUE, sep = "\t", row.names = 1, check.names = FALSE)

# Check the number of genes before filtering
num_genes_before <- nrow(counts)

# Apply filtering: remove genes that have less than 10 counts across all samples
filtered_counts <- counts[rowSums(counts) >= 10, ]

# Check the number of genes after filtering
num_genes_after <- nrow(filtered_counts)

# Report the number of genes before and after filtering
cat("Number of genes before filtering:", num_genes_before, "\n")
cat("Number of genes after filtering:", num_genes_after, "\n")

# Plot distribution of gene counts before and after filtering
before_counts <- rowSums(counts)
after_counts <- rowSums(filtered_counts)

df <- data.frame(
  Counts = c(before_counts, after_counts),
  Status = rep(c("Before Filtering", "After Filtering"), c(length(before_counts), length(after_counts)))
)
df$Status <- factor(df$Status, levels = c("Before Filtering", "After Filtering")) # make red in the back and cyan in the front

ggplot(df, aes(x = Counts, fill = Status)) +
  geom_histogram(bins = 50, alpha = 0.5, position = "identity") +
  scale_x_log10() + 
  theme_minimal() +
  labs(title = "Distribution of Gene Counts Before and After Filtering",
       subtitle = paste0("Number of genes before filtering: ", num_genes_before, "\n", "Number of genes after filtering: ", num_genes_after),
       x = "Log10(Counts)", y = "Number of Genes") +
  theme(legend.position = "top")
  

```




## Performing differential expression analysis using the filtered counts
Number of significant genes at padj < 0.001: 405

```{r}
# DESeq2 requires a counts matrix, column data (sample information), and a formula
# the counts matrix *must be raw counts*
# Ensure it's a matrix and preserve row names
padj_thresh <- 0.001
count_mat <- as.matrix(filtered_counts)

coldata <- data.frame(
  condition = c("control", "experimental", "control", "experimental", "experimental", "control"),
  row.names = colnames(count_mat)  # Ensure row names match count matrix column names
)



# Create DESeq2 dataset
dds <- DESeqDataSetFromMatrix(countData = count_mat, 
                              colData = coldata, 
                              design = ~condition)

# Run DESeq2 normalization and DE analysis
dds <- DESeq(dds)

# Extract results
res <- results(dds, alpha = padj_thresh)  # Adjust threshold as needed

###### Significant DEGs ######
gene_names <- read.table('results/gencode_v45_gene_mapping.txt', header = TRUE, sep = "\t")

# Filter for significant genes
sig_genes <- res %>%
  as.data.frame() %>%
  filter(padj < padj_thresh) %>%
  rownames_to_column(var = "gene") %>% 
  arrange(padj)  %>% # genes ranked by padj
  left_join(gene_names, by=c('gene' = 'Ensembl_ID')) %>%
  relocate(Gene_Name, .after = gene)


# Choose an appropriate padj threshold and report the number of significant genes at this threshold.
# Report number of significant genes
num_sig_genes <- nrow(sig_genes)
print(paste0("Number of significant genes at padj < ", padj_thresh, ": ", num_sig_genes))

# A table containing the DESeq2 results for the top ten significant genes
top10_genes <- sig_genes %>%
  head(10)
top10_genes

```


### The results from a DAVID or ENRICHR analysis on the significant genes at your chosen padj threshold. Comment in a notebook what results you find most interesting from this analysis.

Many of the significant genes were related to cell development like cell adhesion (4.4E-7 pvalue), extracellular matrix (ECM) (3.7E-10 pvalue), and glycoprotein (3.7E-10 pvalue). This could mean the genes are important in how cells interact with their environment with tissue remodeling, metastasis, or immune responses to disease or treatments.

### RNAseq Quality Control Plots
The PCA plot indicates that the control and experimental samples have clear clustering and suggests that the experimental condition significantly influences gene expression. There is an experimental outlier that is far from all of the other samples, and could be due to batch effects or other technical issues. PC1 and PC2 also make up a large percentage of variance (86% and 10% respectively) which shows that they capture the major differences between the two conditions. 

Looking at the heatmap, the replicates are clustering together except for the one outlier I noticed in the PCA plot. The experimental outlier clusters with the control samples, so we'd need to check for possible mislabeling, contamination, or batch effects. Overall, this analysis indicates that the data is has clear experimental effects and mostly consistent sample relationships.

```{r}

# for (g in sig_genes$Gene_Name){
#   cat(g, '\n')
# }


# Perform variance-stabilizing transformation
vsd <- vst(dds, blind=TRUE)

# Extract the normalized counts
normalized_counts <- assay(vsd)

# PCA plot of PC1 vs PC2
pca_data <- plotPCA(vsd, intgroup="condition", returnData=TRUE)
percentVar <- round(100 * attr(pca_data, "percentVar"))

ggplot(pca_data, aes(PC1, PC2, color=condition)) +
  geom_point(size=3) +
  xlab(paste0("PC1: ", percentVar[1], "% variance")) +
  ylab(paste0("PC2: ", percentVar[2], "% variance")) +
  theme_minimal() +
  ggtitle("PCA of Samples")

```




```{r}
######## Heatmap

# Compute Euclidean distance between samples
sample_dist <- dist(t(assay(vsd)))

# Convert to matrix for heatmap visualization
sample_dist_matrix <- as.matrix(sample_dist)
rownames(sample_dist_matrix) <- colnames(vsd)
colnames(sample_dist_matrix) <- colnames(vsd)

# Generate the heatmap
pheatmap(sample_dist_matrix, clustering_distance_rows=sample_dist, clustering_distance_cols=sample_dist,
         main="Sample-to-Sample Distance Matrix")


```






### FGSEA Analysis
I am seeing pathways related to breast cancer (HUPER_BREAST_BASAL_VS_LUMINAL_UP, SCHUETZ_BREAST_CANCER_DUCTAL_INVASIVE_UP, NABA_MATRISOME_POORLY_METASTATIC_BREAST_CANCER) and the extracellular matrix (REACTOME_ASSEMBLY_OF_COLLAGEN_FIBRILS_AND_OTHER_MULTIMERIC_STRUCTURES, REACTOME_EXTRACELLULAR_MATRIX_ORGANIZATION). This makes me wonder if this analysis is hinting at something in breast cancer cells and the tumor progression.


```{r}
# Load DESeq2 results
res <- results(dds, contrast = c("condition", "experimental", "control"))
labeled_results <- rownames_to_column(res %>% as.data.frame(), 'Ensembl_ID')
id2gene_path <- '/projectnb/bf528/students/mindyt5/project-1-mindy-tran/results/gencode_v45_gene_mapping.txt'
gmt_file_path <- '/projectnb/bf528/students/mindyt5/project-1-mindy-tran/refs/c2.all.v2024.1.Hs.symbols.gmt'
min_size <- 5
max_size <- 500

make_ranked_log2fc <- function(labeled_results, id2gene_path) {
  #first load in the id2gene.txt appropriately
  id2gene <- read_delim(id2gene_path, col_names = c('Ensembl_ID', 'Gene_Name'))
  
  # join to add a new column in your labeled results that matches IDs to symbols
  labeled_results <- labeled_results %>% 
    left_join(id2gene, by='Ensembl_ID') %>%
    arrange(desc(log2FoldChange)) %>% # log2FC values in descending order
    drop_na()
  
  # generate a named vector of symbols
  result <- labeled_results$log2FoldChange
  names(result) <- labeled_results$Gene_Name
  
  return(result)
}


run_fgsea <- function(gmt_file_path, rnk_list, min_size, max_size) {
  # load GMT file
  pathways <- fgsea::gmtPathways(gmt_file_path)
  
  # Run fgsea and make tibble of results
  result <- fgsea::fgsea(
    pathways = pathways,
    stats = rnk_list,
    minSize = min_size,
    maxSize = max_size
  )
  result <- as_tibble(result)
  
  return(result)
}

top_pathways <- function(fgsea_results, num_paths){
  # get top twenty pathways ranked by positive and negative NES
  top_positive <- fgsea_results %>%
    arrange(desc(NES)) %>%
    head(num_paths) %>%  # Get top positive pathways
    mutate(top_NES = "pos")  # Add category
  
  top_negative <- fgsea_results %>%
    arrange(NES) %>%
    head(num_paths) %>%  # Get top negative pathways
    mutate(top_NES = "neg")  # Add category
  
  # Combine top positive and negative results
  top_results <- bind_rows(top_positive, top_negative)
  top_results$pathway <- gsub("_"," ", top_results$pathway)
  
  
  # Create the bar plot
  g <- ggplot(top_results, aes(x = reorder(stringr::str_wrap(pathway, 70), NES), y = NES, fill = top_NES)) +
    geom_bar(stat = "identity", show.legend = FALSE) +
    coord_flip() + # flip coordinates
    labs(title = "fgsea results for Hallmark MSigDB gene se",
         x = NULL,  
         y = "Normalized Enrichment Score (NES)",
         fill = "NES Category") +
    theme_minimal() +
    scale_fill_manual(values = c("pos" = "lightblue", "neg" = "pink")) +
    theme(
      axis.text = element_text(size = 6)
    )
  
  return(g)
}



# Main
ranked_list <- make_ranked_log2fc(labeled_results, id2gene_path)
fgsea_results <- run_fgsea(gmt_file_path, ranked_list, min_size, max_size)

padj_thresh <- 0.01
top_fgsea <- fgsea_results %>%
  filter(padj < padj_thresh) %>%
  arrange(desc(NES))  # Sort by enrichment score

# plot top 10 pathways
top_pathways(top_fgsea, num_paths = 10)
```





